# Phoenix Trading System - 실거래 전 체크리스트

**작성일**: 2026-01-23
**버전**: v1.0
**대상**: SOXL 자동매매 시스템 실거래 배포

---

## 📋 1. Excel 파일 필수 설정

### A. 기본 투자 설정 (B2~B8)

| 셀 | 항목 | 설정값 예시 | 필수 여부 | 비고 |
|---|---|---|---|---|
| B2 | 계좌번호 | (선택) | ❌ | KIS 계좌번호로 대체 가능 |
| B3 | 종목코드 | SOXL | ✅ | **변경 불가** |
| B4 | 총 투자금 (USD) | 10000 | ✅ | 실제 투자할 총 금액 |
| B5 | 총 티어 개수 | 240 | ✅ | 기본값 권장 |
| B6 | 티어당 투자금 | `=B4/B5` | ✅ | **수식으로 설정** (자동 계산됨) |
| B7 | Tier 1 자동 업데이트 | TRUE | ✅ | 고점 추적 활성화 |
| B8 | Tier 1 거래 활성화 | FALSE | ✅ | Tier 2부터 매수 시작 권장 |

### B. 매매 제한 설정 (B9~B10)

| 셀 | 항목 | 권장값 | 비고 |
|---|---|---|---|
| B9 | 매수 제한 | FALSE | TRUE 설정 시 매수 중단 |
| B10 | 매도 제한 | FALSE | TRUE 설정 시 매도 중단 |

### C. KIS API 인증 설정 (B12~B15) ⭐ **필수**

| 셀 | 항목 | 발급처 | 형식 예시 | 비고 |
|---|---|---|---|---|
| B12 | KIS APP KEY | 한국투자증권 개발자센터 | PSxxxxxxxxxxxxxx | 실계좌 KEY 사용 |
| B13 | KIS APP SECRET | 한국투자증권 개발자센터 | xxxxxxxxxxxxxxxx | 실계좌 SECRET 사용 |
| B14 | KIS 계좌번호 | 한국투자증권 계좌 | 12345678-01 | 하이픈 포함 가능 |
| B15 | 시스템 가동 여부 | FALSE → **TRUE** | TRUE/FALSE | **거래 시작 스위치** |

**⚠️ 중요**:
- B15를 TRUE로 설정하기 전에 모든 설정을 다시 확인하세요!
- 모의투자 KEY와 실계좌 KEY는 다릅니다. 반드시 실계좌용 KEY를 입력하세요.

### D. 시스템 설정 (B16, B21)

| 셀 | 항목 | 기본값 | 권장값 | 비고 |
|---|---|---|---|---|
| B16 | 시세 조회 주기 (초) | 40.0 | 40~60 | KIS API Rate Limit 고려 |
| B21 | Excel 업데이트 주기 (초) | 1.0 | 1~5 | 실시간 모니터링용 |

### E. 텔레그램 알림 (B18~B20) - 선택사항

| 셀 | 항목 | 필수 여부 |
|---|---|---|
| B18 | 텔레그램 ID | ❌ |
| B19 | 텔레그램 토큰 | ❌ |
| B20 | 텔레그램 활성화 | ❌ |

---

## ✅ 2. 실거래 전 최종 체크리스트

### Phase 1: Excel 설정 검증

- [ ] **B4 (총 투자금)**: 실제 투자 가능한 금액으로 설정
- [ ] **B6 (티어당 투자금)**: `=B4/B5` 수식 확인 (값: $41.67 for $10,000)
- [ ] **B12~B14 (KIS API 인증)**: 실계좌 KEY/SECRET/계좌번호 입력 완료
- [ ] **B15 (시스템 가동)**: 아직 FALSE 상태 유지 (마지막 단계에서 변경)

### Phase 2: 코드베이스 검증

- [ ] **티어당 투자금 자동 계산**: `excel_bridge.py:184-196` 로직 확인
  ```python
  # B6이 수식이거나 비어있으면 자동 계산
  tier_amount = investment_usd / total_tiers
  ```

- [ ] **매수 수량 계산**: `grid_engine.py:711-712`
  ```python
  raw_qty = tier_amount / current_price
  quantity = max(1, floor(raw_qty))
  ```

- [ ] **잔고 차감 로직**: `grid_engine.py:306-309`
  ```python
  if self.account_balance < invested:
      raise ValueError("잔고 부족")
  self.account_balance -= invested
  ```

### Phase 3: 거래 로직 검증

- [ ] **매수 조건**: 현재가 <= 티어 매수가 (Tier 1 - 0.5% × (tier-1))
- [ ] **매도 조건**: 현재가 >= 티어 매도가 (티어 매수가 × 1.03)
- [ ] **배치 주문**: 여러 티어 동시 트리거 시 수량 합산 후 1번 주문
- [ ] **부분 체결**: 높은 티어부터 순차적으로 제거

### Phase 4: KIS API 연결 테스트

- [ ] **OAuth2 로그인**: `kis_adapter.login()` 성공 확인
- [ ] **현재가 조회**: `get_overseas_price("SOXL")` 정상 응답
- [ ] **잔고 조회**: `get_balance()` 예수금 확인
- [ ] **계좌번호 파싱**: `_parse_account_no()` CANO/ACNT_PRDT_CD 분리

---

## 🚨 3. 위험 관리 및 주의사항

### A. 자금 관리

1. **초기 투자금 권장**: $100 ~ $500 (소액 테스트)
2. **총 투자금 검증**:
   - 잘못된 설정 예: B6=500 (하드코딩) → 총 투자금 $120,000 (500×240)
   - 올바른 설정: B6=`=B4/B5` → 총 투자금 = B4 값

3. **잔고 부족 시나리오**:
   ```
   매수 시도 → 잔고 부족 → WARNING 로그 → 주문 중단 (오류 아님)
   ```

### B. 거래 제한

1. **Buy Limit (B9=TRUE)**: 매수 중단, 매도만 실행
2. **Sell Limit (B10=TRUE)**: 매도 중단, 매수만 실행
3. **System Running (B15=FALSE)**: 시스템 전체 중지

### C. Tier 1 설정

| 설정 | 효과 |
|---|---|
| B7=TRUE, B8=FALSE | Tier 1 추적만 (매수 없음, Tier 2부터 시작) ✅ 권장 |
| B7=TRUE, B8=TRUE | Tier 1 추적 + 매수 (고점 돌파 시 매수) |
| B7=FALSE | Tier 1 고정 (초기 설정값 유지) |

### D. 실거래 시나리오 예시

**시나리오 1: 급락 진입 (SOXL $25 → $24)**
```
현재가 $24.00
→ Tier 2~9 (8개 티어) 동시 트리거
→ 배치 주문: 총 8주 × $24 = $192 (1번 주문)
→ 잔고 차감: $10,000 → $9,808
```

**시나리오 2: 부분 체결 (6주만 체결)**
```
주문: 8주
체결: 6주 (부분 체결)
→ Tier 2~7 각 1주씩 분배 (8개→6개 티어로 재분배)
→ 실제 투자: $144
```

**시나리오 3: 매도 트리거**
```
Tier 2 보유: 1주 @ $24.88
현재가: $25.70
Tier 2 매도가: $25.62 (= $24.88 × 1.03)
→ 매도 신호 발생: 1주 @ $25.70
→ 수익: $0.82 (3.30%)
```

---

## 🚀 4. 거래 시작 절차 (Step-by-Step)

### Step 1: Excel 템플릿 준비
```bash
# 1. Excel 파일 위치 확인
phoenix_grid_template_v3.xlsx

# 2. 시트 이동: "01_매매전략_기준설정"
# 3. B4~B14 항목 입력
```

### Step 2: 시스템 초기화 (B15=FALSE 상태)
```bash
# EXE 실행 (거래 시작 안 됨)
PhoenixTrading.exe phoenix_grid_template_v3.xlsx

# 예상 출력:
# [STOP] 시스템이 중지 상태입니다 (Excel B15=FALSE)
# 이것은 에러가 아닙니다!
```

### Step 3: KIS API 연결 확인
```
로그 확인:
✅ KIS REST API 연결 중...
✅ [OK] KIS API 로그인 성공
✅ SOXL 초기 시세 조회 중...
✅ 현재가: $25.00
✅ 계좌 잔고 조회 중...
✅ 예수금: $10,000.00
```

### Step 4: 거래 시작
```bash
# 1. Excel 파일 열기
# 2. B15 셀을 TRUE로 변경
# 3. 저장 (Ctrl+S)
# 4. 프로그램 재시작

# 예상 출력:
# Phoenix Trading System v4.1 초기화
# GridEngine 초기화 중...
# [AUTO] 티어당 투자금 자동 계산: $41.67 = $10,000 / 240 tiers
# 시스템 실행: ON
# 🚀 자동매매 시작!
```

### Step 5: 실시간 모니터링
```
메인 루프:
- 40초마다 SOXL 시세 조회
- 매수/매도 조건 확인
- 신호 발생 시 주문 전송
- Excel 업데이트 (1초마다)

Excel 시트 확인:
- "01_매매전략_기준설정": E2~E8 실시간 업데이트
- "02_운용로그_히스토리": 거래 기록 추가 (append-only)
```

---

## 📊 5. Excel 데이터 필드 매핑

### 01_매매전략_기준설정 (실시간 업데이트 영역)

| 셀 | 필드명 | 데이터 소스 | 업데이트 주기 |
|---|---|---|---|
| E2 | 최근 업데이트 시간 | `state.last_update` | 1초 |
| E3 | 현재 티어 | `state.current_tier` | 1초 |
| E4 | 현재가 | `state.current_price` | 1초 |
| E5 | 잔고 | `state.account_balance` | 1초 |
| E6 | 총 보유 수량 | `state.total_quantity` | 1초 |
| E7 | 매수 상태 | `state.buy_status` | 1초 |
| E8 | 매도 상태 | `state.sell_status` | 1초 |

### 02_운용로그_히스토리 (거래 기록)

| 컬럼 | 필드명 | 설명 |
|---|---|---|
| A | 업데이트 시간 | YYYY-MM-DD HH:MM:SS |
| B | 날짜 | YYYY-MM-DD |
| C | 시트명 | "Main" |
| D | 종목코드 | "SOXL" |
| E | 현재 티어 | 1~240 |
| F | 총 티어 | 240 |
| G | 수량차 | 총 보유 수량 |
| H | 투자금 | 총 투자 금액 |
| I | 1티어 금액 | 티어당 투자금 |
| J | 예수금 | 계좌 잔고 |
| K | 주식평가금 | 보유 주식 평가액 |
| L | 잔고수익 | 수익률 (%) |
| M | 매수예정 | 다음 매수 가능 금액 |
| N | 인출가능 | 인출 가능 금액 |
| O | 아비타수익 | 차익거래 수익 |
| P | 매수 수량 | 최근 매수 체결 수량 |
| Q | 매도 수량 | 최근 매도 체결 수량 |

---

## 🔒 6. 비상 상황 대응

### 시스템 즉시 중단 방법

**방법 1: Excel 설정 변경**
```
1. Excel 파일 열기
2. B15 셀을 FALSE로 변경
3. 저장 후 프로그램 재시작
```

**방법 2: 프로그램 종료**
```
Ctrl+C (터미널에서)
또는
작업 관리자에서 PhoenixTrading.exe 종료
```

### 로그 확인 위치
```
D:\Project\SOLX\logs\phoenix_YYYYMMDD_HHMMSS.log
```

### 긴급 연락처
- 한국투자증권 고객센터: 1544-5000
- KIS API 장애 신고: 개발자센터 문의

---

## ✅ 최종 배포 승인 체크

실거래 시작 전 아래 항목을 **모두** 확인하세요:

- [ ] B4 (총 투자금) 소액 ($100~$500) 설정 완료
- [ ] B6 수식 `=B4/B5` 확인 완료
- [ ] B12~B14 KIS 실계좌 인증 정보 입력 완료
- [ ] B15는 아직 FALSE (마지막 단계에서 TRUE로 변경)
- [ ] KIS API 로그인 테스트 성공
- [ ] SOXL 현재가 조회 성공
- [ ] 계좌 잔고 조회 성공
- [ ] 로그 파일 정상 생성 확인
- [ ] Excel 자동 업데이트 동작 확인
- [ ] Ctrl+C 종료 테스트 완료

**모든 항목 확인 후 B15=TRUE로 변경하여 실거래 시작!**

---

**문서 버전**: v1.0
**작성자**: Claude Code
**최종 수정**: 2026-01-23
